#!/usr/bin/env bash
# vi: ft=bash

set -e

# --- Color Setup ---
GREEN=''
RED=''
RESET=''
if [[ -t 1 ]]; then # Check if stdout is a TTY (to support colors)
  GREEN='\033[0;32m'
  RED='\033[0;31m'
  RESET='\033[0m'
fi
# --- End Color Setup ---

echo -e "${GREEN}âš™ï¸${RESET} Updating Git submodules..."
git submodule update --init --recursive --quiet

echo -e "${GREEN}ðŸ”${RESET} Checking Zola installation..."
if ! command -v zola &>/dev/null; then
  echo -e "${RED}âŒ${RESET} Error: Zola is not installed. Please install Zola to proceed." >&2
  echo -e "${RED}ðŸ“š${RESET} See: https://www.getzola.org/documentation/getting-started/installation/" >&2
  exit 1
fi

echo -e "${GREEN}ðŸ—ï¸${RESET} Building Zola site..."
# Redirect stdout to /dev/null to suppress Zola's regular build output,
# but allow stderr (errors) to pass through.
zola build &>/dev/null

pushd public &>/dev/null

echo -e "${GREEN}ðŸŒ±${RESET} Initializing Git repository in public/ (if not already present)..."
if [ ! -d ".git" ]; then
  git init --quiet
fi

echo -e "${GREEN}ðŸŒ${RESET} Verifying Git remote 'origin' configuration..."
REQUIRED_ORIGIN="git@github.com:reykatsck1218/www.reykats.com.git"
CURRENT_ORIGIN=$(git remote get-url origin 2>/dev/null || echo "")

if [ "$CURRENT_ORIGIN" != "$REQUIRED_ORIGIN" ]; then
  echo -e "${GREEN}ðŸ”—${RESET} Configuring Git remote 'origin'..."
  if git remote get-url origin &>/dev/null; then
    git remote set-url origin "$REQUIRED_ORIGIN" &>/dev/null
  else
    git remote add origin "$REQUIRED_ORIGIN" &>/dev/null
  fi
else
  echo -e "${GREEN}âœ…${RESET} Git remote 'origin' is correctly configured."
fi

echo -e "${GREEN}ðŸ“„${RESET} Creating .nojekyll file to prevent Jekyll processing..."
touch .nojekyll

if [ -f "../CNAME" ]; then
  echo -e "${GREEN}ðŸ“‹${RESET} Copying CNAME file..."
  cp ../CNAME . &>/dev/null
fi

echo -e "${GREEN}âž•${RESET} Staging changes for commit..."
git add -A

echo -e "${GREEN}ðŸ’¾${RESET} Committing changes..."
if git diff --cached --exit-code --quiet; then
  echo -e "${GREEN}âž¡ï¸${RESET} No new changes to commit."
else
  git commit -m "Deploy to GitHub Pages" --quiet
fi

echo -e "${GREEN}ðŸš€${RESET} Pushing to gh-pages branch..."
git push -f origin HEAD:gh-pages --quiet

echo -e "${GREEN}ðŸŽ‰${RESET} Deployment complete."

popd &>/dev/null
